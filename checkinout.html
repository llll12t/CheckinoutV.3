<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>บันทึกการเข้าออกงาน</title>
  
  <!-- 1) นำเข้า Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2) นำเข้า SweetAlert2 สำหรับแสดงกล่องข้อความแจ้งเตือน -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- 3) นำเข้า LIFF SDK ของ LINE -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  
  <!-- 4) นำเข้า face-api.js (ต้องการสำหรับประมวลผลใบหน้า) -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

  <style>
    /* การตั้งค่าสำหรับ overlay ที่ใช้แสดงสถานะการโหลด */
    #loadingOverlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgb(255 255 255 / 80%);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    /* การตั้งค่าสำหรับ container ของการโหลด */
    .loading-container {
      position: relative;
    }

    /* การตั้งค่าการกระพริบของข้อความ */
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .blink {
      animation: blink 1s infinite;
    }
  </style>
</head>

<body class="bg-white h-screen">
  <!-- กล่องใหญ่ที่เป็นกล่องสีขาวสำหรับเนื้อหาหลักของหน้า -->
  <div class="max-w-md mx-auto p-6">

    <!-- กล่องแสดงวันที่และเวลา -->
    <div class="bg-slate-800 border rounded-lg text-white text-center mb-4 py-8 px-4">
      <div class="daytime">
        <div id="date"></div>
        <div class="text-5xl text-bold" id="time"></div>
        <!-- ฟิลด์ที่ซ่อนอยู่สำหรับรับค่า วันที่ และ เวลา -->
        <input type="date" id="todayInput" name="todayInput" class="hidden">
        <input type="time" id="currentTime" name="currentTime" class="hidden">
      </div>
    </div>

    <!-- กล่องแสดงข้อมูลผู้ใช้ (Step 1) -->
    <div id="step1">
      <!-- หน้าต่างโหลดที่แสดงในขณะดึงข้อมูล -->
      <div class="loading-container bg-slate-100 p-4 rounded-lg">
        <div id="loadingOverlay">
          <div class="text-center text-gray-800">ค้นหารายชื่อ..</div>
        </div>
        <!-- ส่วนสำหรับกรอกข้อมูลชื่อ, รหัสพนักงาน, และตำแหน่ง -->
        <div class="w-full p-2 space-y-6">
          <!-- ฟิลด์ชื่อ-สกุล -->
          <div class="relative">
            <label for="columnBData" class="absolute -top-2 left-3 text-xs bg-slate-100 px-1 text-slate-800 font-semibold">ชื่อ-สกุล</label>
            <input type="text"
                   class="w-full px-4 py-3 text-sm bg-slate-100 border-2 border-slate-800 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-800"
                   id="columnBData" placeholder="ชื่อ-สกุล" name="columnBData" required>
          </div>
        </div>
        <div class="w-full p-2 space-y-6">
          <div class="relative">
            <label for="columnCData" class="absolute -top-2 left-3 text-xs bg-slate-100 px-1 text-slate-800 font-semibold">รหัสพนักงาน</label>
            <input type="text"
                   class="w-full px-4 py-3 text-sm bg-slate-100 border-2 border-slate-800 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-800"
                   id="columnCData" placeholder="รหัสพนักงาน" name="columnCData" required>
          </div>
        </div>
        <div class="w-full p-2 space-y-6">
          <div class="relative">
            <label for="columnDData" class="absolute -top-2 left-3 text-xs bg-slate-100 px-1 text-slate-800 font-semibold">ตำแหน่ง</label>
            <input type="text"
                   class="w-full px-4 py-3 text-sm bg-slate-100 border-2 border-slate-800 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-800"
                   id="columnDData" placeholder="ตำแหน่ง" name="columnDData" required>
          </div>
        </div>
        <!-- ฟิลด์ที่ซ่อนอยู่สำหรับเก็บข้อมูลที่ไม่ต้องแสดงผล -->
        <input type="hidden" id="userId" name="userId" />
        <input type="hidden" id="columnAData" name="columnAData" />
      </div>

      <div class="switch-field my-6 space-y-4">
        <!-- แถวบน: เข้างาน (ซ้าย) และ ออกงาน (ขวา) -->
        <div class="flex space-x-2">
          <!-- ปุ่ม เข้างาน -->
          <div class="w-1/2 flex items-center">
            <input type="radio" id="radio-three" name="switch-job" value="เข้างาน" class="hidden" />
            <label for="radio-three"
                   class="cursor-pointer border border-gray-300 px-4 py-3 rounded-lg w-full flex items-center justify-center">
              <!-- จุดสีเขียว -->
              <span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span>
              เข้างาน
            </label>
          </div>
          <!-- ปุ่ม ออกงาน -->
          <div class="w-1/2 flex items-center">
            <input type="radio" id="radio-five" name="switch-job" value="ออกงาน" class="hidden" />
            <label for="radio-five"
                   class="cursor-pointer border border-gray-300 px-4 py-3 rounded-lg w-full flex items-center justify-center">
              <!-- จุดสีแดง -->
              <span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span>
              ออกงาน
            </label>
          </div>
        </div>
        <!-- แถวล่าง: ปุ่ม ระหว่างวัน -->
        <div class="flex pt-2">
          <input type="radio" id="radio-four" name="switch-job" value="ระหว่างวัน" class="hidden" />
          <label for="radio-four"
                 class="cursor-pointer border border-gray-300 py-3  rounded-lg w-full text-center">
            ระหว่างวัน
          </label>
        </div>
      </div>

      <input type="hidden" id="jobInput" name="jobInput" required>
      <!-- หมายเหตุ -->
      <textarea class="input-field w-full border border-gray-300 rounded-lg p-4 text-gray-700" placeholder="Note"
                id="noteInput"></textarea>
      
      <!-- ปุ่มสำหรับไปยังขั้นตอนถัดไป -->
      <div class="bg-slate-800 text-white text-center rounded-lg my-4">
        <button class="p-4 w-full" onclick="nextStep()">ถัดไป</button>
      </div>
    </div>

    <!-- ขั้นตอนที่สอง: ถ่ายรูป -->
    <div id="step2" class="hidden text-center">
      <div class="photo pb-4">
        <center>
          <video id="camera-preview" width="70%" height="auto" autoplay playsinline
                 poster="https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/No-Image-Placeholder.svg/330px-No-Image-Placeholder.svg.png"
                 class="rounded-lg"></video>
        </center>
        <center>
          <img id="preview" width="70%" height="auto" alt="" required class="rounded-lg">
        </center>
        <div class="flex justify-center space-x-4 my-4 px-8">
          <button class="w-full text-sm text-center py-2 px-4 rounded-lg bg-[#001D53] text-white"
                  id="start-camera-btn">เปิดกล้อง</button>
          <button class="w-full text-sm text-center py-4 px-4 rounded-lg bg-green-500 text-white"
                  id="capture-btn" disabled>ถ่ายรูป</button>
          <button id="switch-camera-btn" class="py-2 px-4 rounded-lg bg-slate-100 text-black" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"
                 color="#000000" fill="none">
              <path d="M15.1667 0.999756L15.7646 2.11753C16.1689 2.87322 16.371 3.25107 16.2374 3.41289C16.1037 3.57471 15.6635 3.44402 14.7831 3.18264C13.9029 2.92131 12.9684 2.78071 12 2.78071C6.75329 2.78071 2.5 6.90822 2.5 11.9998C2.5 13.6789 2.96262 15.2533 3.77093 16.6093M8.83333 22.9998L8.23536 21.882C7.83108 21.1263 7.62894 20.7484 7.7626 20.5866C7.89627 20.4248 8.33649 20.5555 9.21689 20.8169C10.0971 21.0782 11.0316 21.2188 12 21.2188C17.2467 21.2188 21.5 17.0913 21.5 11.9998C21.5 10.3206 21.0374 8.74623 20.2291 7.39023"
                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="input-group py-4 flex justify-between space-x-4">
        <button class="w-full text-center p-4 rounded-lg bg-gray-300" onclick="prevStep()">กลับ</button>
        <button class="w-full text-center p-4 rounded-lg bg-slate-800 text-white"
                onclick="checkPictureAndNextStep()">ถัดไป</button>
      </div>
    </div>

    <!-- ขั้นตอนที่สาม: ยืนยันที่อยู่ -->
    <div id="step3" class="hidden text-center">
      <div class="submit">
        <div class="w-full mb-4 rounded-lg bg-slate-800 text-white">
          <button type="button" onclick="getLocation()" class="w-full p-4 rounded-lg blink">
            กดเพื่อยืนยันที่อยู่ของคุณ
          </button>
        </div>
        <div id="locationInfo" name="locationInfo" class="bg-white p-4 rounded-lg shadow-sm max-w-sm mx-auto my-4">
          <div class="flex justify-between">
            <p id="latitude" class="text-gray-700 font-medium pb-2">Latitude: </p>
            <p id="longitude" class="text-gray-700 font-medium pb-2">Longitude: </p>
          </div>
          <p id="fullAddress">สถานที่</p>
        </div>
        <!-- ฟิลด์ที่ซ่อนอยู่สำหรับเก็บข้อมูลที่อยู่ -->
        <input type="hidden" id="latitudeInput" name="latitudeInput">
        <input type="hidden" id="longitudeInput" name="longitudeInput">
        <input type="hidden" id="fullAddressInput" name="fullAddressInput" required>
      </div>

      <!-- แสดงแผนที่ Google Maps -->
      <iframe id="mapIframe" class="p-2 rounded-lg shadow-md" width="100%" height="240"
              frameborder="0" style="border:0;" allowfullscreen="" aria-hidden="false"
              tabindex="0"></iframe>

      <div class="input-group my-4 py-4 flex justify-between">
        <button class="w-1/4 text-center p-4  m-2 rounded-lg bg-gray-300" onclick="prevStep()">กลับ</button>
        <button id="submitButton" class="w-3/4 text-center p-4 m-2 rounded-lg bg-slate-800 text-white"
                onclick="submitForm()">บันทึกข้อมูล</button>
      </div>
    </div>
  </div>

  <script>
    // -------------------------------------------------------------------------
    // CONFIG & INIT
    // -------------------------------------------------------------------------
    // URL ของ Google Apps Script (member / check-in-out) และ LIFF ID
    const WEB_APP_MEMBER_URL = 'https://script.google.com/macros/s/AKfycbxKtQXKqAOxIOb8Pgh6Gg3h6-YHj8WnPTC0Lhl-Gq_aFSfWXoxfMRSo2vKFY7pa8yP6EQ/exec'; // APPSCRIP MEMBER
    const WEB_APP_URL        = 'https://script.google.com/macros/s/AKfycbwLkcQkCQppkiiGRrGT6yN6O4KPbPaJAeOlgtv3u6yGh2aF0ubVNgIi4oDIyslajxUj/exec';  // APPSCRIP CHECK-IN-OUT
    const LIFF_ID            = '2006740306-qp2xNvgM'; // Liff ID

    // ฟังก์ชันนี้จะถูกเรียกใช้เมื่อโหลดหน้าเว็บเสร็จสมบูรณ์
    window.onload = async function () {
      // เริ่มต้น LIFF
      await initializeLiff();
      // ตั้งค่าเวลา/วันที่
      updateDateTime();
      setInterval(updateDateTime, 1000); // อัพเดตทุก 1 วินาที
    };

    // ฟังก์ชันเริ่มต้น LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (liff.isLoggedIn()) {
          getUserProfile();
        } else {
          liff.login();
        }
      } catch (error) {
        console.error('Error initializing LIFF:', error);
      }
    }

    // ฟังก์ชันดึงข้อมูลโปรไฟล์จาก LIFF
    async function getUserProfile() {
      try {
        const profile = await liff.getProfile();
        const userId = profile.userId;
        document.getElementById('userId').value = userId;
        await fetchData(userId);
      } catch (error) {
        console.error('Error getting profile data:', error);
      }
    }

    // -------------------------------------------------------------------------
    // ดึงข้อมูลพนักงานจาก Apps Script (fetchData)
    // -------------------------------------------------------------------------
    async function fetchData(userId) {
      showLoading(true);
      try {
        const response = await fetch(`${WEB_APP_MEMBER_URL}`, {
          method: 'POST',
          body: JSON.stringify({ action: 'fetchData', userId: userId })
        });
        const data = await response.json();
        const userRows = data.filter(row => row[1] === userId);
        if (userRows.length > 0) {
          userRows.sort((a, b) => new Date(b[6]) - new Date(a[6]));
          displayData(userRows[0]);
        } else {
          console.log('No data found for userId:', userId);
        }
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        showLoading(false);
      }
    }

    function displayData(row) {
      // อ้างอิง columns จากข้อมูล Apps Script
      document.getElementById('columnAData').value = row[1] || '';
      document.getElementById('columnBData').value = row[2] || '';
      document.getElementById('columnCData').value = row[3] || '';
      document.getElementById('columnDData').value = row[4] || '';
    }

    function showLoading(isLoading) {
      const overlay = document.getElementById('loadingOverlay');
      const inputs = document.querySelectorAll('.input-field');
      if (isLoading) {
        overlay.style.display = 'flex';
        inputs.forEach(input => input.disabled = true);
      } else {
        overlay.style.display = 'none';
        inputs.forEach(input => input.disabled = false);
      }
    }

    // -------------------------------------------------------------------------
    // อัปเดตวันที่และเวลาในหน้า
    // -------------------------------------------------------------------------
    function updateDateTime() {
      const dateElement = document.getElementById('date');
      const timeElement = document.getElementById('time');
      const now = new Date();

      // รูปแบบวันที่ (ไทย)
      const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      // รูปแบบเวลา
      const timeOptions = { hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false, timeZone: 'Asia/Bangkok' };

      dateElement.textContent = now.toLocaleDateString('th-TH', dateOptions);
      timeElement.textContent  = now.toLocaleTimeString('en-US', timeOptions);
    }

    // ตั้งค่าเวลาและวันที่ให้ input
    document.getElementById('currentTime').value = getCurrentTimeInBangkok();
    document.getElementById('todayInput').value  = getFormattedDate();

    function getCurrentTimeInBangkok() {
      const now = new Date();
      const bangkokTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Bangkok' }));
      const hours   = String(bangkokTime.getHours()).padStart(2, '0');
      const minutes = String(bangkokTime.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    function getFormattedDate() {
      const today = new Date();
      const year  = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day   = String(today.getDate()).padStart(2, '0');
      return `${day}/${month}/${year}`;
    }

    // -------------------------------------------------------------------------
    // การเลือกประเภทงาน (เข้างาน, ออกงาน, ระหว่างวัน)
    // -------------------------------------------------------------------------
    document.querySelectorAll('input[name="switch-job"]').forEach(radio => {
      radio.addEventListener('change', function () {
        document.getElementById('jobInput').value = this.value;
        document.querySelectorAll('.switch-field label').forEach(label => {
          label.classList.remove('bg-slate-800', 'text-white');
        });
        document.querySelector(`label[for="${this.id}"]`).classList.add('bg-slate-800', 'text-white');
      });
    });

    // -------------------------------------------------------------------------
    // จัดการการข้าม Step (step1 -> step2 -> step3)
    // -------------------------------------------------------------------------
    let currentStep = 1;
    function nextStep() {
      if (currentStep < 3) {
        document.getElementById(`step${currentStep}`).classList.add('hidden');
        currentStep++;
        document.getElementById(`step${currentStep}`).classList.remove('hidden');
      }
    }
    function prevStep() {
      if (currentStep > 1) {
        document.getElementById(`step${currentStep}`).classList.add('hidden');
        currentStep--;
        document.getElementById(`step${currentStep}`).classList.remove('hidden');
      }
    }

    // -------------------------------------------------------------------------
    //  โหลดโมเดล face-api.js
    // -------------------------------------------------------------------------
    async function loadFaceApiModels() {
      // สมมติว่ามีโฟลเดอร์ /models เก็บโมเดล TinyFaceDetector
      // หากต้องการโหลดจาก CDN หรือที่อื่น เปลี่ยนได้ตามต้องการ
      const MODEL_URL = '/models';
      await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
      console.log('face-api.js models loaded');
    }

    // -------------------------------------------------------------------------
    // เปิดกล้อง + ถ่ายรูป (Step2) + ใช้ face-api.js
    // -------------------------------------------------------------------------
    let stream;
    let currentFacingMode = "user"; // เริ่มที่กล้องหน้า

    document.addEventListener("DOMContentLoaded", async function () {
      // โหลดโมเดล face-api.js ก่อน
      await loadFaceApiModels();

      const video            = document.getElementById("camera-preview");
      const startCameraBtn   = document.getElementById("start-camera-btn");
      const captureBtn       = document.getElementById("capture-btn");
      const switchCameraBtn  = document.getElementById("switch-camera-btn");
      const previewImage     = document.getElementById("preview");

      // ฟังก์ชันเปิดกล้อง
      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
          video.srcObject = stream;
          captureBtn.disabled      = false;
          switchCameraBtn.disabled = false;
          video.style.display      = "block";
          previewImage.style.display = "none";
        } catch (error) {
          console.error("Error accessing camera: ", error);
          alert("ไม่สามารถเข้าถึงกล้องได้ กรุณาตรวจสอบการอนุญาต.");
        }
      }

      // ฟังก์ชันถ่ายรูป + ใช้ face-api.js
      async function capturePhoto() {
        // 1) สร้าง canvas ขึ้นมาเพื่อวาดภาพจาก video
        const canvas  = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.width  = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // 2) ตรวจจับใบหน้าบน canvas
        const detections = await faceapi.detectAllFaces(canvas, new faceapi.TinyFaceDetectorOptions());

        // 3) เบลอ/ปรับผิวใน bounding box ของใบหน้า
        detections.forEach(det => {
          const { x, y, width, height } = det.box;
          
          // -- ตัวอย่างง่าย ๆ: ใช้ filter = blur(3px) กับบริเวณใบหน้า --
          const oldFilter = context.filter;
          context.filter   = 'blur(3px)';
          context.drawImage(canvas, x, y, width, height, x, y, width, height);
          context.filter   = oldFilter;
          
          // หมายเหตุ: ถ้าต้องการ “หน้าใส” กว่านี้ อาจต้องทำ custom smoothing/brightness
        });

        // 4) แปลงเป็น dataURL เพื่อแสดงใน <img>
        const dataURL = canvas.toDataURL("image/png");
        previewImage.src          = dataURL;
        previewImage.style.display = "block";
        video.style.display       = "none";
      }

      // ฟังก์ชันสลับกล้อง
      function switchCamera() {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        currentFacingMode = (currentFacingMode === "environment") ? "user" : "environment";
        startCamera();
      }

      // ผูก Event ให้ปุ่ม
      startCameraBtn.addEventListener("click", startCamera);
      captureBtn.addEventListener("click", capturePhoto);
      switchCameraBtn.addEventListener("click", switchCamera);
    });

    // ฟังก์ชันตรวจสอบว่ามีรูปแล้วหรือยัง ก่อนข้ามไปขั้นถัดไป
    function checkPictureAndNextStep() {
      const capturedImage = document.getElementById('preview').src;
      if (!capturedImage || capturedImage.includes('No-Image-Placeholder')) {
        Swal.fire({
          title: 'แจ้งเตือน!',
          text: 'กรุณาถ่ายรูปก่อนที่จะไปยังขั้นตอนถัดไป',
          icon: 'warning',
          confirmButtonText: 'OK',
        });
      } else {
        nextStep();
      }
    }

    // -------------------------------------------------------------------------
    // Step 3: ดึงที่อยู่ปัจจุบัน
    // -------------------------------------------------------------------------
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(displayLocation);
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }

    function displayLocation(position) {
      const latitude  = position.coords.latitude;
      const longitude = position.coords.longitude;
      document.getElementById("latitude").innerText  = `Latitude: ${latitude}`;
      document.getElementById("longitude").innerText = `Longitude: ${longitude}`;
      document.getElementById("latitudeInput").value  = latitude;
      document.getElementById("longitudeInput").value = longitude;

      // ดึงที่อยู่จาก OpenStreetMap
      const reverseGeocodingUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`;
      fetch(reverseGeocodingUrl)
        .then(response => response.json())
        .then(data => {
          if (data.display_name) {
            const fullAddress = data.display_name;
            document.getElementById("fullAddress").innerText     = `ที่อยู่ของคุณ: ${fullAddress}`;
            document.getElementById("fullAddressInput").value    = fullAddress;
          } else {
            document.getElementById("fullAddress").innerText = "Unable to retrieve full address.";
          }
        })
        .catch(error => {
          console.error("Error fetching reverse geocoding data:", error);
          document.getElementById("fullAddress").innerText = "Error fetching reverse geocoding data.";
        });

      // แสดงแผนที่ Google Maps
      const mapsUrl = `https://www.google.com/maps?q=${latitude},${longitude}&output=embed`;
      document.getElementById("mapIframe").src = mapsUrl;
    }

    // -------------------------------------------------------------------------
    // ส่งข้อมูลไป Google Apps Script
    // -------------------------------------------------------------------------
    async function submitForm() {
      const columnBData = document.getElementById("columnBData");
      const columnCData = document.getElementById("columnCData");
      const jobInput    = document.getElementById("jobInput");
      const noteInput   = document.getElementById("noteInput");
      const todayInput  = document.getElementById("todayInput");
      const currentTime = document.getElementById("currentTime");
      const latitudeInput   = document.getElementById("latitudeInput");
      const longitudeInput  = document.getElementById("longitudeInput");
      const fullAddressInput= document.getElementById("fullAddressInput");
      const userId = document.getElementById("userId");
      const preview = document.getElementById('preview');

      // ตรวจสอบว่ากรอกข้อมูลจำเป็นครบไหม
      if (!columnBData.value || !columnCData.value || !jobInput.value ||
          !latitudeInput.value || !longitudeInput.value) {
        Swal.fire({
          title: 'แจ้งเตือน!',
          text: 'กรุณากรอกข้อมูลที่จำเป็น (*) ให้ครบถ้วน',
          icon: 'warning',
          confirmButtonText: 'OK',
        });
        return;
      }

      // ยืนยันการส่งข้อมูล
      Swal.fire({
        title: 'ยืนยันการส่งข้อมูล',
        text: 'คุณแน่ใจหรือไม่ที่ต้องการส่งข้อมูล?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ยืนยัน',
        cancelButtonText: 'ยกเลิก',
      }).then((result) => {
        if (result.isConfirmed) {
          document.getElementById('submitButton').disabled = true; // ป้องกันส่งซ้ำ
          Swal.fire({
            title: 'กำลังบันทึกข้อมูล',
            text: 'กรุณารอสักครู่...',
            showConfirmButton: false,
            allowOutsideClick: false,
            onBeforeOpen: () => {
              Swal.showLoading();
            }
          });
          let base64String = preview.src.split("base64,")[1]; 
          let obj = {
            base64: base64String,
            name: columnBData.value,
            role: columnCData.value,
            job: jobInput.value,
            note: noteInput.value,
            today: todayInput.value,
            time: currentTime.value,
            lat: latitudeInput.value,
            long: longitudeInput.value,
            address: fullAddressInput.value,
            user: userId.value
          };

          fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify(obj),
          })
          .then(response => response.text())
          .then(data => {
            Swal.close();
            Swal.fire({
              title: 'สำเร็จ!',
              text: 'บันทึกข้อมูลของคุณเรียบร้อย!',
              icon: 'success',
              confirmButtonText: 'ปิด',
            }).then(() => {
              sendFlexMessage();
              console.log(data);
            });
          })
          .catch(error => {
            Swal.close();
            Swal.fire({
              title: 'Error!',
              text: 'Form submission failed. Please try again.',
              icon: 'error',
              confirmButtonText: 'OK',
            }).then(() => {
              document.getElementById('submitButton').disabled = false;
            });
            console.error(error);
          });
        }
      });
    }

    // -------------------------------------------------------------------------
    // ส่ง Flex Message กลับไปใน LIFF chat
    // -------------------------------------------------------------------------
    async function sendFlexMessage() {
      const jobInput      = document.getElementById("jobInput");
      const columnBData   = document.getElementById("columnBData");
      const columnCData   = document.getElementById("columnCData");
      const todayInput    = document.getElementById("todayInput");
      const currentTime   = document.getElementById("currentTime");
      const fullAddressInput = document.getElementById("fullAddressInput");

      let jobColor = '#000000FF';
      if (jobInput.value === 'เข้างาน')  jobColor = '#0D9608FF';
      if (jobInput.value === 'ออกงาน')   jobColor = '#EF2F14FF';

      const flexMessage = {
        type: 'flex',
        altText: 'จดบันทึกเวลางาน',
        contents: {
          type: 'bubble',
          direction: 'ltr',
          body: {
            type: 'box',
            layout: 'vertical',
            spacing: 'md',
            contents: [
              {
                type: 'box',
                layout: 'horizontal',
                contents: [
                  {
                    type: 'text',
                    text: 'บันทึกเวลางาน',
                    weight: 'bold',
                    size: 'md',
                    align: 'start',
                    margin: 'sm'
                  },
                  {
                    type: 'text',
                    text: ` ${jobInput.value}`,
                    weight: 'bold',
                    size: 'md',
                    color: jobColor,
                    align: 'end'
                  }
                ]
              },
              { type: 'separator' },
              {
                type: 'box',
                layout: 'vertical',
                spacing: 'sm',
                contents: [
                  {
                    type: 'box',
                    layout: 'baseline',
                    contents: [
                      {
                        type: 'text',
                        text: 'ชื่อพนักงาน',
                        weight: 'bold',
                        size: 'sm'
                      },
                      {
                        type: 'text',
                        text: `${columnBData.value}`,
                        size: 'sm',
                        color: '#000000FF',
                        align: 'end'
                      }
                    ]
                  },
                  {
                    type: 'box',
                    layout: 'baseline',
                    contents: [
                      {
                        type: 'text',
                        text: 'รหัสพนักงาน',
                        weight: 'bold',
                        size: 'sm',
                        flex: 0
                      },
                      {
                        type: 'text',
                        text: `${columnCData.value}`,
                        size: 'sm',
                        color: '#000000FF',
                        align: 'end'
                      }
                    ]
                  }
                ]
              },
              { type: 'separator' },
              {
                type: 'box',
                layout: 'vertical',
                contents: [
                  {
                    type: 'box',
                    layout: 'baseline',
                    contents: [
                      {
                        type: 'text',
                        text: 'วันที่',
                        weight: 'bold'
                      },
                      {
                        type: 'text',
                        text: `${todayInput.value}`,
                        weight: 'bold',
                        align: 'end'
                      }
                    ]
                  },
                  {
                    type: 'box',
                    layout: 'baseline',
                    contents: [
                      {
                        type: 'text',
                        text: 'เวลา',
                        weight: 'bold'
                      },
                      {
                        type: 'text',
                        text: `${currentTime.value}`,
                        weight: 'bold',
                        size: 'xl',
                        color: '#EF2F14FF',
                        align: 'end'
                      }
                    ]
                  }
                ]
              },
              { type: 'separator' },
              {
                type: 'box',
                layout: 'vertical',
                spacing: 'xs',
                margin: 'sm',
                contents: [
                  {
                    type: 'text',
                    text: 'สถานที่',
                    weight: 'bold',
                    size: 'sm',
                    margin: 'md'
                  },
                  {
                    type: 'text',
                    text: fullAddressInput.value
                      ? `${fullAddressInput.value}`
                      : 'ข้อมูลไม่พร้อมแสดง แต่เราเก็บพิกัดของคุณเรียบร้อย',
                    wrap: true
                  }
                ]
              }
            ]
          }
        }
      };

      await liff.sendMessages([flexMessage]);
      liff.closeWindow();
    }
  </script>
</body>
</html>
